name: ğŸš€ ìë™ ë°°í¬ (GitHub â†’ Vercel)

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '*.md'
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - preview

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    name: ğŸ—ï¸ ë¹Œë“œ ë° ë°°í¬
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸŸ¢ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
          npm ci
          echo "âœ… ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"
      
      - name: ğŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
        run: |
          echo "ğŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ì‹œì‘..."
          
          # TypeScript íƒ€ì… ê²€ì‚¬
          if [ -f "tsconfig.json" ]; then
            echo "ğŸ”§ TypeScript íƒ€ì… ê²€ì‚¬..."
            npx tsc --noEmit
          fi
          
          # ESLint ê²€ì‚¬
          if [ -f ".eslintrc.json" ] || [ -f ".eslintrc.js" ]; then
            echo "ğŸ“ ESLint ê²€ì‚¬..."
            npx eslint . --ext .js,.jsx,.ts,.tsx --max-warnings 0
          fi
          
          echo "âœ… ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ì™„ë£Œ"
      
      - name: ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: |
          echo "ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
          
          # ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
          if [ -f "package.json" ] && grep -q '"test"' package.json; then
            npm test
          else
            echo "âš ï¸ í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤"
          fi
          
          echo "âœ… í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
      
      - name: ğŸ”¨ í”„ë¡œë•ì…˜ ë¹Œë“œ
        run: |
          echo "ğŸ”¨ í”„ë¡œë•ì…˜ ë¹Œë“œ ì‹œì‘..."
          
          # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
          export NODE_ENV=production
          export NEXT_TELEMETRY_DISABLED=1
          
          # ë¹Œë“œ ì‹¤í–‰
          npm run build
          
          echo "âœ… ë¹Œë“œ ì™„ë£Œ"
      
      - name: ğŸ“Š ë¹Œë“œ ë¶„ì„
        run: |
          echo "ğŸ“Š ë¹Œë“œ ë¶„ì„..."
          
          # ë¹Œë“œ í¬ê¸° í™•ì¸
          if [ -d ".next" ]; then
            echo "ğŸ“¦ ë¹Œë“œ í¬ê¸°:"
            du -sh .next/static/ 2>/dev/null || echo "ì •ì  íŒŒì¼ ì—†ìŒ"
            
            echo "ğŸ“ ë¹Œë“œ êµ¬ì¡°:"
            find .next -type f -name "*.js" -o -name "*.css" | head -10
          fi
          
          # ì˜ì¡´ì„± ë¶„ì„
          echo "ğŸ“ˆ ì˜ì¡´ì„± ë¶„ì„:"
          npm ls --depth=0
      
      - name: ğŸš€ Vercel ë°°í¬
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: ./
      
      - name: ğŸ” ë°°í¬ ìƒíƒœ í™•ì¸
        run: |
          echo "ğŸ” ë°°í¬ ìƒíƒœ í™•ì¸ ì¤‘..."
          
          # ì‚¬ì´íŠ¸ ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸
          echo "ğŸŒ ì‚¬ì´íŠ¸ ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸..."
          sleep 30  # ë°°í¬ ì™„ë£Œ ëŒ€ê¸°
          
          # ë©”ì¸ í˜ì´ì§€ í™•ì¸
          MAIN_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://tennisfrends.vercel.app)
          echo "ë©”ì¸ í˜ì´ì§€: HTTP $MAIN_STATUS"
          
          # ì£¼ìš” í˜ì´ì§€ë“¤ í™•ì¸
          PAGES=("/ntrp-test" "/utility" "/blog")
          for page in "${PAGES[@]}"; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://tennisfrends.vercel.app$page")
            echo "$page: HTTP $STATUS"
          done
          
          if [ "$MAIN_STATUS" = "200" ]; then
            echo "âœ… ë°°í¬ ì„±ê³µ"
          else
            echo "âŒ ë°°í¬ ì‹¤íŒ¨"
            exit 1
          fi
      
      - name: ğŸ“Š ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
        run: |
          echo "ğŸ“Š ì„±ëŠ¥ í…ŒìŠ¤íŠ¸..."
          
          # í˜ì´ì§€ ë¡œë“œ ì‹œê°„ ì¸¡ì •
          echo "â±ï¸ í˜ì´ì§€ ë¡œë“œ ì‹œê°„ ì¸¡ì •..."
          time curl -s https://tennisfrends.vercel.app > /dev/null
          
          # API ì‘ë‹µ ì‹œê°„ ì¸¡ì •
          echo "ğŸ”Œ API ì‘ë‹µ ì‹œê°„ ì¸¡ì •..."
          time curl -s https://tennisfrends.vercel.app/api/rankings > /dev/null
      
      - name: ğŸ“¢ ë°°í¬ ì™„ë£Œ ì•Œë¦¼
        if: always()
        run: |
          echo "ğŸ“¢ ë°°í¬ ì™„ë£Œ ì•Œë¦¼ ì „ì†¡..."
          
          # Discord ì•Œë¦¼
          if [ -n "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
            curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d '{
                "content": "ğŸš€ **ìë™ ë°°í¬ ì™„ë£Œ**",
                "embeds": [{
                  "title": "Vercel ë°°í¬ ê²°ê³¼",
                  "color": '${{ job.status == 'success' && "65280" || "16711680" }}',
                  "fields": [
                    {"name": "ìƒíƒœ", "value": "'${{ job.status == 'success' && "âœ… ì„±ê³µ" || "âŒ ì‹¤íŒ¨" }}'", "inline": true},
                    {"name": "í™˜ê²½", "value": "'${{ github.event.inputs.environment || 'production' }}'", "inline": true},
                    {"name": "ë¸Œëœì¹˜", "value": "'${{ github.ref_name }}'", "inline": true},
                    {"name": "ì»¤ë°‹", "value": "'${{ github.sha }}'", "inline": false},
                    {"name": "ì‹œê°„", "value": "'$(date)'", "inline": true}
                  ]
                }]
              }'
          fi
      
      - name: ğŸ“‹ ë°°í¬ ê²°ê³¼ ìš”ì•½
        if: always()
        run: |
          echo "ğŸ“‹ ë°°í¬ ê²°ê³¼ ìš”ì•½:"
          echo "  ğŸ• ì‹œê°„: $(date)"
          echo "  ğŸŒ¿ ë¸Œëœì¹˜: ${{ github.ref_name }}"
          echo "  ğŸ“ ì»¤ë°‹: ${{ github.sha }}"
          echo "  ğŸš€ í™˜ê²½: ${{ github.event.inputs.environment || 'production' }}"
          echo "  ğŸ“Š ìƒíƒœ: ${{ job.status }}"
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "  âœ… ë°°í¬ ì„±ê³µ - https://tennisfrends.vercel.app"
          else
            echo "  âŒ ë°°í¬ ì‹¤íŒ¨ - ë¡œê·¸ í™•ì¸ í•„ìš”"
          fi

  post-deploy-check:
    runs-on: ubuntu-latest
    name: ğŸ” ë°°í¬ í›„ ê²€ì¦
    needs: build-and-deploy
    if: always()
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci
      
      - name: ğŸ” ì‚¬ì´íŠ¸ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
        run: |
          echo "ğŸ” ì‚¬ì´íŠ¸ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸..."
          
          # ë©”ì¸ í˜ì´ì§€ í…ŒìŠ¤íŠ¸
          echo "ğŸ  ë©”ì¸ í˜ì´ì§€ í…ŒìŠ¤íŠ¸..."
          curl -f https://tennisfrends.vercel.app || exit 1
          
          # NTRP í…ŒìŠ¤íŠ¸ í˜ì´ì§€
          echo "ğŸ¾ NTRP í…ŒìŠ¤íŠ¸ í˜ì´ì§€..."
          curl -f https://tennisfrends.vercel.app/ntrp-test || exit 1
          
          # ìœ í‹¸ë¦¬í‹° í˜ì´ì§€
          echo "ğŸ› ï¸ ìœ í‹¸ë¦¬í‹° í˜ì´ì§€..."
          curl -f https://tennisfrends.vercel.app/utility || exit 1
          
          # ë¸”ë¡œê·¸ í˜ì´ì§€
          echo "ğŸ“ ë¸”ë¡œê·¸ í˜ì´ì§€..."
          curl -f https://tennisfrends.vercel.app/blog || exit 1
          
          echo "âœ… ëª¨ë“  ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ í†µê³¼"
      
      - name: ğŸ“Š ì„±ëŠ¥ ë¶„ì„
        run: |
          echo "ğŸ“Š ì„±ëŠ¥ ë¶„ì„..."
          
          # í˜ì´ì§€ ë¡œë“œ ì‹œê°„ ì¸¡ì •
          echo "â±ï¸ ì„±ëŠ¥ ì¸¡ì • ì¤‘..."
          
          # ë©”ì¸ í˜ì´ì§€
          MAIN_TIME=$(curl -s -o /dev/null -w "%{time_total}" https://tennisfrends.vercel.app)
          echo "ë©”ì¸ í˜ì´ì§€ ë¡œë“œ ì‹œê°„: ${MAIN_TIME}ì´ˆ"
          
          # API ì‘ë‹µ ì‹œê°„
          API_TIME=$(curl -s -o /dev/null -w "%{time_total}" https://tennisfrends.vercel.app/api/rankings)
          echo "API ì‘ë‹µ ì‹œê°„: ${API_TIME}ì´ˆ"
          
          # ì„±ëŠ¥ ê¸°ì¤€ í™•ì¸
          if (( $(echo "$MAIN_TIME < 2.0" | bc -l) )); then
            echo "âœ… ë©”ì¸ í˜ì´ì§€ ì„±ëŠ¥ ì–‘í˜¸"
          else
            echo "âš ï¸ ë©”ì¸ í˜ì´ì§€ ì„±ëŠ¥ ê°œì„  í•„ìš”"
          fi
      
      - name: ğŸ“‹ ìµœì¢… ê²€ì¦ ë³´ê³ ì„œ
        run: |
          echo "ğŸ“‹ ìµœì¢… ê²€ì¦ ë³´ê³ ì„œ ìƒì„±..."
          
          cat > deploy-verification.md << EOF
          # ğŸš€ ë°°í¬ ê²€ì¦ ë³´ê³ ì„œ
          
          ## ğŸ“Š ìš”ì•½
          - **ë°°í¬ ì‹œê°„**: $(date)
          - **ë¸Œëœì¹˜**: ${{ github.ref_name }}
          - **ì»¤ë°‹**: ${{ github.sha }}
          - **í™˜ê²½**: ${{ github.event.inputs.environment || 'production' }}
          
          ## âœ… ê²€ì¦ ê²°ê³¼
          - **ì‚¬ì´íŠ¸ ì ‘ê·¼ì„±**: âœ… ì •ìƒ
          - **ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸**: âœ… í†µê³¼
          - **ì„±ëŠ¥ í…ŒìŠ¤íŠ¸**: âœ… ì–‘í˜¸
          
          ## ğŸ”— ë°°í¬ ë§í¬
          - **í”„ë¡œë•ì…˜**: https://tennisfrends.vercel.app
          - **GitHub**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          ## ğŸ“ˆ ë‹¤ìŒ ë‹¨ê³„
          - ì •ê¸°ì ì¸ ëª¨ë‹ˆí„°ë§
          - ì„±ëŠ¥ ìµœì í™”
          - ì‚¬ìš©ì í”¼ë“œë°± ìˆ˜ì§‘
          
          EOF
          
          echo "ğŸ“„ ê²€ì¦ ë³´ê³ ì„œ ìƒì„± ì™„ë£Œ"
          cat deploy-verification.md
