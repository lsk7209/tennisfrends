name: ğŸ¯ ê°œë°œ ì™„ë£Œ ìë™ ë°°í¬

on:
  workflow_dispatch:
    inputs:
      deploy_type:
        description: 'ë°°í¬ ìœ í˜•'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - preview
          - staging
      force_deploy:
        description: 'ê°•ì œ ë°°í¬'
        required: false
        default: false
        type: boolean
      notify_team:
        description: 'íŒ€ ì•Œë¦¼'
        required: false
        default: true
        type: boolean

jobs:
  pre-deployment-check:
    runs-on: ubuntu-latest
    name: ğŸ” ë°°í¬ ì „ ê²€ì‚¬
    outputs:
      ready_to_deploy: ${{ steps.check.outputs.ready }}
      build_status: ${{ steps.check.outputs.build_status }}
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸŸ¢ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
          npm ci
          echo "âœ… ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"
      
      - name: ğŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
        id: check
        run: |
          echo "ğŸ” ë°°í¬ ì „ ê²€ì‚¬ ì‹œì‘..."
          
          # 1. TypeScript íƒ€ì… ê²€ì‚¬
          echo "ğŸ”§ TypeScript íƒ€ì… ê²€ì‚¬..."
          if [ -f "tsconfig.json" ]; then
            npx tsc --noEmit
            if [ $? -eq 0 ]; then
              echo "âœ… TypeScript íƒ€ì… ê²€ì‚¬ í†µê³¼"
            else
              echo "âŒ TypeScript íƒ€ì… ì˜¤ë¥˜ ë°œê²¬"
              echo "ready=false" >> $GITHUB_OUTPUT
              echo "build_status=failed" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi
          
          # 2. ESLint ê²€ì‚¬
          echo "ğŸ“ ESLint ê²€ì‚¬..."
          if [ -f ".eslintrc.json" ] || [ -f ".eslintrc.js" ]; then
            npx eslint . --ext .js,.jsx,.ts,.tsx --max-warnings 0
            if [ $? -eq 0 ]; then
              echo "âœ… ESLint ê²€ì‚¬ í†µê³¼"
            else
              echo "âŒ ESLint ì˜¤ë¥˜ ë°œê²¬"
              echo "ready=false" >> $GITHUB_OUTPUT
              echo "build_status=failed" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi
          
          # 3. ë¹Œë“œ í…ŒìŠ¤íŠ¸
          echo "ğŸ”¨ ë¹Œë“œ í…ŒìŠ¤íŠ¸..."
          npm run build
          if [ $? -eq 0 ]; then
            echo "âœ… ë¹Œë“œ ì„±ê³µ"
            echo "ready=true" >> $GITHUB_OUTPUT
            echo "build_status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ ë¹Œë“œ ì‹¤íŒ¨"
            echo "ready=false" >> $GITHUB_OUTPUT
            echo "build_status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # 4. í…ŒìŠ¤íŠ¸ ì‹¤í–‰
          echo "ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
          if [ -f "package.json" ] && grep -q '"test"' package.json; then
            npm test
            if [ $? -eq 0 ]; then
              echo "âœ… í…ŒìŠ¤íŠ¸ í†µê³¼"
            else
              echo "âš ï¸ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ (ê²½ê³ )"
            fi
          fi
          
          echo "ğŸ¯ ë°°í¬ ì¤€ë¹„ ì™„ë£Œ!"
      
      - name: ğŸ“Š ì½”ë“œ ë¶„ì„
        run: |
          echo "ğŸ“Š ì½”ë“œ ë¶„ì„..."
          
          # ë³€ê²½ëœ íŒŒì¼ í™•ì¸
          echo "ğŸ“ ìµœê·¼ ë³€ê²½ì‚¬í•­:"
          git log --oneline -10
          
          # ì½”ë“œ í†µê³„
          echo "ğŸ“ˆ ì½”ë“œ í†µê³„:"
          find . -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" | wc -l
          
          # ì˜ì¡´ì„± ë¶„ì„
          echo "ğŸ“¦ ì˜ì¡´ì„± ë¶„ì„:"
          npm ls --depth=0
      
      - name: ğŸš¨ ë°°í¬ ì¤€ë¹„ ìƒíƒœ ì•Œë¦¼
        if: steps.check.outputs.ready == 'false'
        run: |
          echo "ğŸš¨ ë°°í¬ ì¤€ë¹„ ì‹¤íŒ¨ - ìˆ˜ì • í•„ìš”"
          
          if [ -n "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
            curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d '{
                "content": "ğŸš¨ **ë°°í¬ ì¤€ë¹„ ì‹¤íŒ¨**",
                "embeds": [{
                  "title": "ê°œë°œ ì™„ë£Œ ë°°í¬ ì‹¤íŒ¨",
                  "color": 16711680,
                  "fields": [
                    {"name": "ìƒíƒœ", "value": "âŒ ë°°í¬ ì¤€ë¹„ ì‹¤íŒ¨", "inline": true},
                    {"name": "ë¹Œë“œ ìƒíƒœ", "value": "'${{ steps.check.outputs.build_status }}'", "inline": true},
                    {"name": "ë¸Œëœì¹˜", "value": "'${{ github.ref_name }}'", "inline": true},
                    {"name": "ì»¤ë°‹", "value": "'${{ github.sha }}'", "inline": false},
                    {"name": "ì‹œê°„", "value": "'$(date)'", "inline": true}
                  ]
                }]
              }'
          fi

  deploy-to-vercel:
    runs-on: ubuntu-latest
    name: ğŸš€ Vercel ë°°í¬
    needs: pre-deployment-check
    if: needs.pre-deployment-check.outputs.ready_to_deploy == 'true' || github.event.inputs.force_deploy == 'true'
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci
      
      - name: ğŸ”¨ í”„ë¡œë•ì…˜ ë¹Œë“œ
        run: |
          echo "ğŸ”¨ í”„ë¡œë•ì…˜ ë¹Œë“œ ì‹œì‘..."
          
          # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
          export NODE_ENV=production
          export NEXT_TELEMETRY_DISABLED=1
          
          # ë¹Œë“œ ì‹¤í–‰
          npm run build
          
          echo "âœ… ë¹Œë“œ ì™„ë£Œ"
      
      - name: ğŸš€ Vercel ë°°í¬
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '${{ github.event.inputs.deploy_type == "production" && "--prod" || "" }}'
          working-directory: ./
      
      - name: â±ï¸ ë°°í¬ ì™„ë£Œ ëŒ€ê¸°
        run: |
          echo "â±ï¸ ë°°í¬ ì™„ë£Œ ëŒ€ê¸° ì¤‘..."
          sleep 60  # Vercel ë°°í¬ ì™„ë£Œ ëŒ€ê¸°
          echo "âœ… ë°°í¬ ì™„ë£Œ ëŒ€ê¸° ì™„ë£Œ"
      
      - name: ğŸ” ë°°í¬ ê²€ì¦
        run: |
          echo "ğŸ” ë°°í¬ ê²€ì¦ ì‹œì‘..."
          
          # ì‚¬ì´íŠ¸ ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸
          echo "ğŸŒ ì‚¬ì´íŠ¸ ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸..."
          
          # ë©”ì¸ í˜ì´ì§€
          MAIN_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://tennisfrends.vercel.app)
          echo "ë©”ì¸ í˜ì´ì§€: HTTP $MAIN_STATUS"
          
          if [ "$MAIN_STATUS" != "200" ]; then
            echo "âŒ ë©”ì¸ í˜ì´ì§€ ì ‘ê·¼ ì‹¤íŒ¨"
            exit 1
          fi
          
          # ì£¼ìš” í˜ì´ì§€ë“¤ í™•ì¸
          PAGES=("/ntrp-test" "/utility" "/blog")
          for page in "${PAGES[@]}"; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://tennisfrends.vercel.app$page")
            echo "$page: HTTP $STATUS"
            
            if [ "$STATUS" != "200" ]; then
              echo "âš ï¸ $page ì ‘ê·¼ ì‹¤íŒ¨ (ê²½ê³ )"
            fi
          done
          
          echo "âœ… ë°°í¬ ê²€ì¦ ì™„ë£Œ"
      
      - name: ğŸ“Š ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
        run: |
          echo "ğŸ“Š ì„±ëŠ¥ í…ŒìŠ¤íŠ¸..."
          
          # í˜ì´ì§€ ë¡œë“œ ì‹œê°„ ì¸¡ì •
          echo "â±ï¸ ì„±ëŠ¥ ì¸¡ì • ì¤‘..."
          
          # ë©”ì¸ í˜ì´ì§€ ë¡œë“œ ì‹œê°„
          MAIN_TIME=$(curl -s -o /dev/null -w "%{time_total}" https://tennisfrends.vercel.app)
          echo "ë©”ì¸ í˜ì´ì§€ ë¡œë“œ ì‹œê°„: ${MAIN_TIME}ì´ˆ"
          
          # API ì‘ë‹µ ì‹œê°„
          API_TIME=$(curl -s -o /dev/null -w "%{time_total}" https://tennisfrends.vercel.app/api/rankings)
          echo "API ì‘ë‹µ ì‹œê°„: ${API_TIME}ì´ˆ"
          
          # ì„±ëŠ¥ ê¸°ì¤€ í™•ì¸
          if (( $(echo "$MAIN_TIME < 3.0" | bc -l) )); then
            echo "âœ… ì„±ëŠ¥ ì–‘í˜¸"
          else
            echo "âš ï¸ ì„±ëŠ¥ ê°œì„  í•„ìš”"
          fi
      
      - name: ğŸ“¢ ë°°í¬ ì™„ë£Œ ì•Œë¦¼
        if: github.event.inputs.notify_team == 'true'
        run: |
          echo "ğŸ“¢ ë°°í¬ ì™„ë£Œ ì•Œë¦¼ ì „ì†¡..."
          
          if [ -n "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
            curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d '{
                "content": "ğŸ‰ **ê°œë°œ ì™„ë£Œ - ìë™ ë°°í¬ ì„±ê³µ**",
                "embeds": [{
                  "title": "Vercel ë°°í¬ ì™„ë£Œ",
                  "color": 65280,
                  "fields": [
                    {"name": "ìƒíƒœ", "value": "âœ… ë°°í¬ ì„±ê³µ", "inline": true},
                    {"name": "í™˜ê²½", "value": "'${{ github.event.inputs.deploy_type }}'", "inline": true},
                    {"name": "ë¸Œëœì¹˜", "value": "'${{ github.ref_name }}'", "inline": true},
                    {"name": "ì»¤ë°‹", "value": "'${{ github.sha }}'", "inline": false},
                    {"name": "ë°°í¬ URL", "value": "https://tennisfrends.vercel.app", "inline": false},
                    {"name": "ì‹œê°„", "value": "'$(date)'", "inline": true}
                  ]
                }]
              }'
          fi
      
      - name: ğŸ“‹ ë°°í¬ ê²°ê³¼ ìš”ì•½
        run: |
          echo "ğŸ“‹ ë°°í¬ ê²°ê³¼ ìš”ì•½:"
          echo "  ğŸ¯ ë°°í¬ ìœ í˜•: ${{ github.event.inputs.deploy_type }}"
          echo "  ğŸŒ¿ ë¸Œëœì¹˜: ${{ github.ref_name }}"
          echo "  ğŸ“ ì»¤ë°‹: ${{ github.sha }}"
          echo "  ğŸš€ í™˜ê²½: ${{ github.event.inputs.deploy_type }}"
          echo "  ğŸ“Š ìƒíƒœ: ì„±ê³µ"
          echo "  ğŸ”— URL: https://tennisfrends.vercel.app"
          echo "  ğŸ• ì‹œê°„: $(date)"

  post-deployment-monitoring:
    runs-on: ubuntu-latest
    name: ğŸ“Š ë°°í¬ í›„ ëª¨ë‹ˆí„°ë§
    needs: [pre-deployment-check, deploy-to-vercel]
    if: always() && needs.deploy-to-vercel.result == 'success'
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci
      
      - name: ğŸ” ì‚¬ì´íŠ¸ ëª¨ë‹ˆí„°ë§
        run: |
          echo "ğŸ” ì‚¬ì´íŠ¸ ëª¨ë‹ˆí„°ë§ ì‹œì‘..."
          
          # 5ë¶„ê°„ ëª¨ë‹ˆí„°ë§
          for i in {1..5}; do
            echo "ëª¨ë‹ˆí„°ë§ $i/5..."
            
            # ë©”ì¸ í˜ì´ì§€ ìƒíƒœ í™•ì¸
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://tennisfrends.vercel.app)
            echo "  ë©”ì¸ í˜ì´ì§€: HTTP $STATUS"
            
            # ì„±ëŠ¥ ì¸¡ì •
            TIME=$(curl -s -o /dev/null -w "%{time_total}" https://tennisfrends.vercel.app)
            echo "  ë¡œë“œ ì‹œê°„: ${TIME}ì´ˆ"
            
            if [ "$STATUS" = "200" ]; then
              echo "  âœ… ì •ìƒ ì‘ë™"
            else
              echo "  âŒ ì˜¤ë¥˜ ë°œìƒ"
            fi
            
            sleep 60  # 1ë¶„ ëŒ€ê¸°
          done
          
          echo "âœ… ëª¨ë‹ˆí„°ë§ ì™„ë£Œ"
      
      - name: ğŸ“Š ìµœì¢… ìƒíƒœ ë³´ê³ ì„œ
        run: |
          echo "ğŸ“Š ìµœì¢… ìƒíƒœ ë³´ê³ ì„œ ìƒì„±..."
          
          cat > final-deployment-report.md << EOF
          # ğŸ¯ ê°œë°œ ì™„ë£Œ ìë™ ë°°í¬ ë³´ê³ ì„œ
          
          ## ğŸ“Š ë°°í¬ ìš”ì•½
          - **ë°°í¬ ì‹œê°„**: $(date)
          - **ë°°í¬ ìœ í˜•**: ${{ github.event.inputs.deploy_type }}
          - **ë¸Œëœì¹˜**: ${{ github.ref_name }}
          - **ì»¤ë°‹**: ${{ github.sha }}
          - **ê°•ì œ ë°°í¬**: ${{ github.event.inputs.force_deploy }}
          
          ## âœ… ê²€ì¦ ê²°ê³¼
          - **ë°°í¬ ì „ ê²€ì‚¬**: ${{ needs.pre-deployment-check.outputs.build_status }}
          - **Vercel ë°°í¬**: ì„±ê³µ
          - **ì‚¬ì´íŠ¸ ì ‘ê·¼ì„±**: ì •ìƒ
          - **ì„±ëŠ¥**: ì–‘í˜¸
          
          ## ğŸ”— ë°°í¬ ë§í¬
          - **í”„ë¡œë•ì…˜**: https://tennisfrends.vercel.app
          - **GitHub Actions**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          ## ğŸ“ˆ ë‹¤ìŒ ë‹¨ê³„
          - ì‚¬ìš©ì í…ŒìŠ¤íŠ¸ ì§„í–‰
          - ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ì§€ì†
          - í”¼ë“œë°± ìˆ˜ì§‘ ë° ê°œì„ 
          
          ## ğŸ‰ ë°°í¬ ì™„ë£Œ!
          ê°œë°œì´ ì™„ë£Œë˜ì–´ ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤.
          
          EOF
          
          echo "ğŸ“„ ìµœì¢… ë³´ê³ ì„œ ìƒì„± ì™„ë£Œ"
          cat final-deployment-report.md
