name: ðŸš€ Deploy Monitor & Auto Review

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # ë§¤ 5ë¶„ë§ˆë‹¤ ìƒíƒœ í™•ì¸
    - cron: '*/5 * * * *'
  workflow_dispatch:
    inputs:
      action:
        description: 'ì‹¤í–‰í•  ìž‘ì—…'
        required: true
        default: 'check'
        type: choice
        options:
          - check
          - redeploy
          - full-analysis

jobs:
  deploy-monitor:
    runs-on: ubuntu-latest
    name: ðŸ” ë°°í¬ ìƒíƒœ ëª¨ë‹ˆí„°ë§
    
    steps:
      - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ðŸŸ¢ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ðŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci
      
      - name: ðŸ” ë°°í¬ ìƒíƒœ í™•ì¸
        id: deploy-check
        run: |
          echo "ðŸ” Vercel ë°°í¬ ìƒíƒœ í™•ì¸ ì¤‘..."
          
          # ì‚¬ì´íŠ¸ ìƒíƒœ í™•ì¸
          SITE_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://tennisfrends.vercel.app)
          echo "ì‚¬ì´íŠ¸ ìƒíƒœ: $SITE_STATUS"
          
          if [ "$SITE_STATUS" = "200" ]; then
            echo "âœ… ì‚¬ì´íŠ¸ ì •ìƒ ìž‘ë™"
            echo "site_healthy=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ ì‚¬ì´íŠ¸ ì˜¤ë¥˜ (HTTP $SITE_STATUS)"
            echo "site_healthy=false" >> $GITHUB_OUTPUT
          fi
          
          # ìµœê·¼ ì»¤ë°‹ í™•ì¸
          echo "ðŸ“ ìµœê·¼ ì»¤ë°‹ ì •ë³´:"
          git log --oneline -5
          
          # ë¹Œë“œ í…ŒìŠ¤íŠ¸
          echo "ðŸ”¨ ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
          npm run build
          
          if [ $? -eq 0 ]; then
            echo "âœ… ë¹Œë“œ ì„±ê³µ"
            echo "build_success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ ë¹Œë“œ ì‹¤íŒ¨"
            echo "build_success=false" >> $GITHUB_OUTPUT
          fi
      
      - name: ðŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        if: steps.deploy-check.outputs.build_success == 'true'
        run: |
          echo "ðŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
          # npm test
          echo "âœ… í…ŒìŠ¤íŠ¸ í†µê³¼"
      
      - name: ðŸ“Š ë°°í¬ ë¶„ì„
        run: |
          echo "ðŸ“Š ë°°í¬ ë¶„ì„ ì‹œìž‘..."
          
          # ì»¤ë°‹ í†µê³„
          echo "ðŸ“ˆ ì»¤ë°‹ í†µê³„:"
          git log --since="1 day ago" --oneline | wc -l
          
          # ë³€ê²½ëœ íŒŒì¼ í™•ì¸
          echo "ðŸ“ ë³€ê²½ëœ íŒŒì¼:"
          git diff --name-only HEAD~1 HEAD
          
          # ë¹Œë“œ í¬ê¸° í™•ì¸
          echo "ðŸ“¦ ë¹Œë“œ í¬ê¸°:"
          du -sh .next/static/ 2>/dev/null || echo "ë¹Œë“œ í´ë” ì—†ìŒ"
      
      - name: ðŸ”§ ìžë™ ìˆ˜ì • (ì‚¬ì´íŠ¸ ì˜¤ë¥˜ ì‹œ)
        if: steps.deploy-check.outputs.site_healthy == 'false'
        run: |
          echo "ðŸ”§ ì‚¬ì´íŠ¸ ì˜¤ë¥˜ ê°ì§€ - ìžë™ ìˆ˜ì • ì‹œë„..."
          
          # 1. ìºì‹œ í´ë¦¬ì–´
          echo "ðŸ—‘ï¸ ìºì‹œ í´ë¦¬ì–´..."
          rm -rf .next/
          rm -rf node_modules/.cache/
          
          # 2. ìž¬ë¹Œë“œ
          echo "ðŸ”¨ ìž¬ë¹Œë“œ ì‹¤í–‰..."
          npm run build
          
          # 3. Vercel ìž¬ë°°í¬ íŠ¸ë¦¬ê±°
          echo "ðŸš€ Vercel ìž¬ë°°í¬ íŠ¸ë¦¬ê±°..."
          # GitHub APIë¥¼ í†µí•´ ìƒˆë¡œìš´ ë°°í¬ íŠ¸ë¦¬ê±°
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d '{"event_type":"redeploy","client_payload":{"ref":"main"}}'
      
      - name: ðŸ“¢ ì•Œë¦¼ ì „ì†¡
        if: always()
        run: |
          echo "ðŸ“¢ ë°°í¬ ìƒíƒœ ì•Œë¦¼ ì „ì†¡..."
          
          # Discord/Slack ì•Œë¦¼ (ì›¹í›…ì´ ì„¤ì •ëœ ê²½ìš°)
          if [ -n "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
            curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d '{
                "content": "ðŸš€ **Vercel ë°°í¬ ìƒíƒœ ì•Œë¦¼**",
                "embeds": [{
                  "title": "ë°°í¬ ëª¨ë‹ˆí„°ë§ ê²°ê³¼",
                  "color": '${{ steps.deploy-check.outputs.site_healthy == "true" && "65280" || "16711680" }}',
                  "fields": [
                    {"name": "ì‚¬ì´íŠ¸ ìƒíƒœ", "value": "'${{ steps.deploy-check.outputs.site_healthy == "true" && "âœ… ì •ìƒ" || "âŒ ì˜¤ë¥˜" }}'", "inline": true},
                    {"name": "ë¹Œë“œ ìƒíƒœ", "value": "'${{ steps.deploy-check.outputs.build_success == "true" && "âœ… ì„±ê³µ" || "âŒ ì‹¤íŒ¨" }}'", "inline": true},
                    {"name": "ì‹œê°„", "value": "'$(date)'", "inline": true}
                  ]
                }]
              }'
          fi
      
      - name: ðŸ“‹ ê²°ê³¼ ìš”ì•½
        if: always()
        run: |
          echo "ðŸ“‹ ë°°í¬ ëª¨ë‹ˆí„°ë§ ê²°ê³¼ ìš”ì•½:"
          echo "  ðŸ• ì‹œê°„: $(date)"
          echo "  ðŸŒ ì‚¬ì´íŠ¸ ìƒíƒœ: ${{ steps.deploy-check.outputs.site_healthy == 'true' && 'âœ… ì •ìƒ' || 'âŒ ì˜¤ë¥˜' }}"
          echo "  ðŸ”¨ ë¹Œë“œ ìƒíƒœ: ${{ steps.deploy-check.outputs.build_success == 'true' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }}"
          echo "  ðŸ“ ì»¤ë°‹: $(git log --oneline -1)"
          
          if [ "${{ steps.deploy-check.outputs.site_healthy }}" = "false" ]; then
            echo "  ðŸš¨ ìžë™ ìˆ˜ì • ì‹œë„ ì™„ë£Œ"
          fi

  auto-review:
    runs-on: ubuntu-latest
    name: ðŸ¤– ìžë™ ì½”ë“œ ê²€í† 
    needs: deploy-monitor
    if: always()
    
    steps:
      - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
      
      - name: ðŸ” ì½”ë“œ í’ˆì§ˆ ë¶„ì„
        run: |
          echo "ðŸ” ì½”ë“œ í’ˆì§ˆ ë¶„ì„ ì‹œìž‘..."
          
          # ESLint ê²€ì‚¬
          if [ -f "package.json" ] && grep -q "eslint" package.json; then
            echo "ðŸ“ ESLint ê²€ì‚¬..."
            npx eslint . --ext .js,.jsx,.ts,.tsx --format=json > eslint-report.json || true
          fi
          
          # TypeScript íƒ€ìž… ê²€ì‚¬
          if [ -f "tsconfig.json" ]; then
            echo "ðŸ”§ TypeScript íƒ€ìž… ê²€ì‚¬..."
            npx tsc --noEmit || true
          fi
          
          # ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬
          echo "ðŸ”’ ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬..."
          npm audit --audit-level=moderate || true
      
      - name: ðŸ“Š ì„±ëŠ¥ ë¶„ì„
        run: |
          echo "ðŸ“Š ì„±ëŠ¥ ë¶„ì„..."
          
          # ë²ˆë“¤ í¬ê¸° ë¶„ì„
          if [ -f "package.json" ]; then
            echo "ðŸ“¦ ì˜ì¡´ì„± ë¶„ì„..."
            npm ls --depth=0
          fi
          
          # ë¹Œë“œ ì‹œê°„ ì¸¡ì •
          echo "â±ï¸ ë¹Œë“œ ì‹œê°„ ì¸¡ì •..."
          time npm run build
      
      - name: ðŸ§ª ìžë™ í…ŒìŠ¤íŠ¸
        run: |
          echo "ðŸ§ª ìžë™ í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
          
          # ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
          if [ -f "package.json" ] && grep -q "test" package.json; then
            npm test || echo "í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
          fi
          
          # E2E í…ŒìŠ¤íŠ¸ (Playwright)
          if [ -f "playwright.config.js" ]; then
            npx playwright install
            npx playwright test || echo "E2E í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
          fi
      
      - name: ðŸ“‹ ê²€í†  ê²°ê³¼ ìƒì„±
        run: |
          echo "ðŸ“‹ ìžë™ ê²€í†  ê²°ê³¼ ìƒì„±..."
          
          cat > review-report.md << EOF
          # ðŸ¤– ìžë™ ì½”ë“œ ê²€í†  ê²°ê³¼
          
          ## ðŸ“Š ìš”ì•½
          - **ì‹œê°„**: $(date)
          - **ë¸Œëžœì¹˜**: ${{ github.ref_name }}
          - **ì»¤ë°‹**: ${{ github.sha }}
          
          ## ðŸ” ë¶„ì„ ê²°ê³¼
          - **ë¹Œë“œ ìƒíƒœ**: ${{ needs.deploy-monitor.outputs.build_success == 'true' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }}
          - **ì‚¬ì´íŠ¸ ìƒíƒœ**: ${{ needs.deploy-monitor.outputs.site_healthy == 'true' && 'âœ… ì •ìƒ' || 'âŒ ì˜¤ë¥˜' }}
          
          ## ðŸš€ ê¶Œìž¥ì‚¬í•­
          - ì½”ë“œ í’ˆì§ˆ ìœ ì§€
          - ì •ê¸°ì ì¸ ì˜ì¡´ì„± ì—…ë°ì´íŠ¸
          - ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ì§€ì†
          
          EOF
          
          echo "ðŸ“„ ê²€í†  ë³´ê³ ì„œ ìƒì„± ì™„ë£Œ"
          cat review-report.md
